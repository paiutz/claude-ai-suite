<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="description" content="Claude AI Suite - Chat professionale con Claude AI. Supporto multi-modello, tema scuro/chiaro, salvataggio locale e modalità offline.">
    <meta name="keywords" content="Claude AI, Claude 4, AI Chat, Puter.js, Intelligenza Artificiale, Chatbot, OpenAI Alternative">
    <meta name="author" content="Claude AI Suite Team">
    <meta name="robots" content="index, follow">
    <meta name="googlebot" content="index, follow">
    
    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    
    <!-- Content Security Policy - Permissive for Puter.js -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' https: wss: data: blob:;
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.puter.com https://api.puter.com https://puter.com https://cdnjs.cloudflare.com;
        connect-src 'self' https: wss: blob: data: https://api.puter.com https://js.puter.com https://puter.com wss://api.puter.com;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com;
        font-src 'self' data: https://fonts.gstatic.com https://cdnjs.cloudflare.com;
        img-src 'self' data: blob: https: http:;
        media-src 'self' blob: data:;
        worker-src 'self' blob:;
        frame-src 'self' https://puter.com;
        object-src 'none';
        base-uri 'self';
        form-action 'self';
        upgrade-insecure-requests;
    ">
    
    <!-- Preconnect to improve performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://js.puter.com" crossorigin>
    <link rel="preconnect" href="https://api.puter.com" crossorigin>
    <link rel="preconnect" href="https://puter.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
    
    <!-- DNS Prefetch -->
    <link rel="dns-prefetch" href="https://js.puter.com">
    <link rel="dns-prefetch" href="https://api.puter.com">
    <link rel="dns-prefetch" href="https://puter.com">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKNT4AejU+AHo1PgUKNT4IejU+CHo1PgUKNT4AcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAApFPhWaVU4e+lVOH/pVTh/6VU4e+kU+FZAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAApFThb6VU4f+lVOH/pVTh/6VU4f+lVOH/pVTh/6VU4f+kVOFvAAAAAAAAAAAAAAAAAAAAAAAAAAClVOEHpVPha6VU4f+lVOH/pVTh/6VU4f+lVOH/pVTh/6VU4f+lVOH/pVTh/6VT4WulVOEHAAAAAAAAAAAAAAAApVTgHaVU4e+lVOH/nEnf/3UZ2P90GNj/dBjY/3QY2P90GNj/dRnY/5xJ3/+lVOH/pVTh76VU4B0AAAAApVTgB6VU4e+lVOH/dBjY/3QY2P90GNj/dBjY/3QY2P90GNj/dBjY/3QY2P90GNj/dBjY/6VU4f+lVOHvpVTgB6VU4FClVOH/hzDc/3QY2P90GNj/dBjY/3QY2P90GNj/dBjY/3QY2P90GNj/dBjY/3QY2P+HMNz/pVTh/6VU4FClVOGHpVTh/3UZ2P90GNj/dBjY/3QY2P+HMNz/pVTh/6VU4f+HMNz/dBjY/3QY2P90GNj/dRnY/6VU4f+lVOGHpVThh6VU4f91Gdj/dBjY/3QY2P90GNj/hzDc/6VU4f+lVOH/hzDc/3QY2P90GNj/dBjY/3UZ2P+lVOH/pVThh6VU4FClVOH/hzDc/3QY2P90GNj/dBjY/3QY2P90GNj/dBjY/3QY2P90GNj/dBjY/3QY2P+HMNz/pVTh/6VU4FClVOAHpVTh76VU4f90GNj/dBjY/3QY2P90GNj/dBjY/3QY2P90GNj/dBjY/3QY2P90GNj/pVTh/6VU4e+lVOAHAAAAAKVU4B2lVOHvpVTh/5xJ3/91Gdj/dBjY/3QY2P90GNj/dBjY/3UZ2P+cSd//pVTh/6VU4e+lVOAdAAAAAAAAAAAAAAAApVThB6VT4WulVOH/pVTh/6VU4f+lVOH/pVTh/6VU4f+lVOH/pVTh/6VT4WulVOEHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKRU4W+lVOH/pVTh/6VU4f+lVOH/pFThbwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACkU+FZpVTh76VU4f+lVOHvpFPhWQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAKNT4AejU+AHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//8AAP//AADgBwAAwAMAAIABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACAAQAAwAMAAOAHAAD//wAA//8AAA==">
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Claude AI Suite - Professional AI Chat Interface">
    <meta property="og:description" content="Chat professionale con Claude AI. Supporta Claude 3 e Claude 4 (quando disponibile).">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://paiutz.github.io/claude-ai-suite/">
    <meta property="og:image" content="https://paiutz.github.io/claude-ai-suite/assets/images/og-image.png">
    <meta property="og:locale" content="it_IT">
    <meta property="og:site_name" content="Claude AI Suite">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Claude AI Suite">
    <meta name="twitter:description" content="Chat professionale con Claude AI. Interfaccia moderna, veloce e privata.">
    <meta name="twitter:image" content="https://paiutz.github.io/claude-ai-suite/assets/images/og-image.png">
    <meta name="twitter:creator" content="@yourusername">
    
    <!-- PWA Support -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366F1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Claude AI">
    <meta name="application-name" content="Claude AI Suite">
    <meta name="msapplication-TileColor" content="#6366F1">
    <meta name="msapplication-config" content="browserconfig.xml">
    
    <!-- Fonts with fallback -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Font Awesome with integrity check -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" 
          integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" 
          crossorigin="anonymous" 
          referrerpolicy="no-referrer">
    
    <!-- Main Styles -->
    <link rel="stylesheet" href="assets/css/style.css">
    
    <!-- Critical CSS for faster initial render -->
    <style>
        body { margin: 0; padding: 0; overflow: hidden; }
        .loading-screen { 
            position: fixed; 
            inset: 0; 
            background: #0F0F0F; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 9999; 
        }
        .app-container { display: none; }
    </style>
    
    <!-- Debug and Error Handling -->
    <script>
        // Global error handler with detailed logging
        window.DEBUG_MODE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        window.ERROR_LOG = [];
        
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            const errorInfo = {
                message: msg,
                source: url,
                line: lineNo,
                column: columnNo,
                error: error,
                userAgent: navigator.userAgent,
                timestamp: new Date().toISOString()
            };
            
            window.ERROR_LOG.push(errorInfo);
            console.error('🚨 Global Error:', errorInfo);
            
            // Show error in debug mode
            if (window.DEBUG_MODE) {
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    left: 20px;
                    right: 20px;
                    background: #ff4444;
                    color: white;
                    padding: 15px;
                    border-radius: 8px;
                    z-index: 10000;
                    font-family: monospace;
                    font-size: 12px;
                    max-height: 200px;
                    overflow-y: auto;
                `;
                errorDiv.innerHTML = `
                    <strong>Error:</strong> ${msg}<br>
                    <strong>Line:</strong> ${lineNo}, Column: ${columnNo}<br>
                    <strong>Source:</strong> ${url}<br>
                    <button onclick="this.parentElement.remove()" style="
                        position: absolute;
                        top: 5px;
                        right: 5px;
                        background: transparent;
                        border: none;
                        color: white;
                        cursor: pointer;
                        font-size: 18px;
                    ">×</button>
                `;
                document.body.appendChild(errorDiv);
                
                setTimeout(() => errorDiv.remove(), 10000);
            }
            
            return false;
        };
        
        // Promise rejection handler
        window.addEventListener('unhandledrejection', function(event) {
            console.error('🚨 Unhandled Promise Rejection:', event.reason);
            window.ERROR_LOG.push({
                type: 'unhandledRejection',
                reason: event.reason,
                timestamp: new Date().toISOString()
            });
        });
        
        // Performance monitoring
        window.PERFORMANCE_LOG = [];
        window.addEventListener('load', function() {
            const perfData = performance.getEntriesByType('navigation')[0];
            window.PERFORMANCE_LOG.push({
                loadTime: perfData.loadEventEnd - perfData.loadEventStart,
                domReady: perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart,
                totalTime: perfData.loadEventEnd - perfData.fetchStart,
                timestamp: new Date().toISOString()
            });
            console.log('📊 Performance:', window.PERFORMANCE_LOG[0]);
        });
    </script>
    
    <title>Claude AI Suite - Professional AI Chat Interface</title>
    
    <!-- Structured Data for SEO -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Claude AI Suite",
        "description": "Professional AI chat interface powered by Claude and Puter.js",
        "url": "https://paiutz.github.io/claude-ai-suite/",
        "applicationCategory": "CommunicationApplication",
        "operatingSystem": "Any",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD"
        },
        "featureList": [
            "Multi-model support (Claude 3 & 4)",
            "Dark/Light theme",
            "Offline mode",
            "Local storage",
            "Export/Import conversations",
            "Mobile responsive"
        ]
    }
    </script>
</head>
<body>
    <!-- Loading Screen with Progress -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-content">
            <div class="loading-logo">
                <i class="fas fa-robot"></i>
            </div>
            <h2>Claude AI Suite</h2>
            <div class="loading-spinner"></div>
            <p id="loadingStatus">Inizializzazione in corso...</p>
            <div class="loading-progress" id="loadingProgress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <p class="progress-text" id="progressText">0%</p>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app" class="app-container" style="display: none;">
        <!-- Header -->
        <header class="header" role="banner">
            <div class="header-left">
                <button class="menu-toggle" id="menuToggle" aria-label="Toggle menu" type="button">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <span class="logo-text">Claude AI</span>
                </div>
            </div>
            
            <div class="header-center">
                <div class="search-bar" id="searchBar">
                    <i class="fas fa-search"></i>
                    <input type="search" 
                           placeholder="Cerca nelle conversazioni..." 
                           id="searchInput"
                           aria-label="Search conversations"
                           autocomplete="off">
                </div>
            </div>
            
            <div class="header-right">
                <select id="modelSelect" class="model-selector" aria-label="Select AI model">
                    <!-- Claude 4 Ready (for future) -->
                    <optgroup label="Claude 4 (Coming Soon)">
                        <option value="claude-4-opus" disabled>Claude 4 Opus (Q2 2025)</option>
                        <option value="claude-4-sonnet" disabled>Claude 4 Sonnet (Q2 2025)</option>
                        <option value="claude-4-haiku" disabled>Claude 4 Haiku (Q2 2025)</option>
                    </optgroup>
                    <!-- Current Claude 3 Models -->
                    <optgroup label="Claude 3 (Current)">
                        <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                        <option value="claude-3-sonnet-20240229" selected>Claude 3 Sonnet</option>
                        <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                    </optgroup>
                    <!-- Legacy Models -->
                    <optgroup label="Legacy Models">
                        <option value="claude-2.1">Claude 2.1</option>
                        <option value="claude-instant-1.2">Claude Instant</option>
                    </optgroup>
                </select>
                
                <button class="icon-btn" id="themeToggle" aria-label="Toggle theme" type="button">
                    <i class="fas fa-moon"></i>
                </button>
                
                <button class="icon-btn" id="settingsBtn" aria-label="Settings" type="button">
                    <i class="fas fa-cog"></i>
                </button>
                
                <!-- Debug button (only in debug mode) -->
                <button class="icon-btn" id="debugBtn" aria-label="Debug" type="button" style="display: none;">
                    <i class="fas fa-bug"></i>
                </button>
            </div>
        </header>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Sidebar -->
            <aside class="sidebar" id="sidebar" role="navigation">
                <div class="sidebar-header">
                    <button class="new-chat-btn" id="newChatBtn" type="button">
                        <i class="fas fa-plus"></i>
                        <span>Nuova Chat</span>
                    </button>
                </div>
                
                <div class="sidebar-content">
                    <div class="conversations-section">
                        <h3 class="section-title">Conversazioni</h3>
                        <div class="conversations-list" id="conversationsList" role="list">
                            <!-- Conversations will be populated here -->
                        </div>
                    </div>
                </div>
                
                <div class="sidebar-footer">
                    <button class="sidebar-action" id="importBtn" type="button">
                        <i class="fas fa-upload"></i>
                        <span>Importa</span>
                    </button>
                    <button class="sidebar-action" id="exportAllBtn" type="button">
                        <i class="fas fa-download"></i>
                        <span>Esporta</span>
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="main-content" role="main">
                <div class="chat-container" id="chatContainer">
                    <!-- Welcome Screen -->
                    <div class="welcome-screen" id="welcomeScreen">
                        <div class="welcome-content">
                            <h1 class="welcome-title">Benvenuto in Claude AI Suite</h1>
                            <p class="welcome-subtitle">
                                Chat intelligente con Claude AI - Pronto per Claude 4
                            </p>
                            
                            <div class="welcome-features">
                                <div class="welcome-feature">
                                    <div class="feature-icon">
                                        <i class="fas fa-bolt"></i>
                                    </div>
                                    <h3>Ultra Veloce</h3>
                                    <p>Risposte in tempo reale</p>
                                </div>
                                
                                <div class="welcome-feature">
                                    <div class="feature-icon">
                                        <i class="fas fa-shield-alt"></i>
                                    </div>
                                    <h3>100% Privato</h3>
                                    <p>Dati salvati localmente</p>
                                </div>
                                
                                <div class="welcome-feature">
                                    <div class="feature-icon">
                                        <i class="fas fa-moon"></i>
                                    </div>
                                    <h3>Tema Scuro</h3>
                                    <p>Proteggi i tuoi occhi</p>
                                </div>
                                
                                <div class="welcome-feature">
                                    <div class="feature-icon">
                                        <i class="fas fa-mobile-alt"></i>
                                    </div>
                                    <h3>Mobile Ready</h3>
                                    <p>Perfetto su ogni device</p>
                                </div>
                            </div>
                            
                            <div class="welcome-actions">
                                <button class="primary-btn" onclick="app.createNewChat()" type="button">
                                    <i class="fas fa-plus"></i>
                                    Inizia una Nuova Chat
                                </button>
                                <button class="secondary-btn" id="testConnectionBtn" type="button">
                                    <i class="fas fa-network-wired"></i>
                                    Test Connessione
                                </button>
                            </div>
                            
                            <div class="welcome-status" id="welcomeStatus" style="margin-top: 2rem;">
                                <!-- Connection status will appear here -->
                            </div>
                        </div>
                    </div>

                    <!-- Chat View -->
                    <div class="chat-view" id="chatView" style="display: none;">
                        <div class="chat-header">
                            <div class="chat-info">
                                <h2 class="chat-title" id="chatTitle">Nuova Conversazione</h2>
                                <p class="chat-meta" id="chatMeta">0 messaggi</p>
                            </div>
                            <div class="chat-actions">
                                <button class="icon-btn" id="editTitleBtn" aria-label="Edit title" type="button">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="icon-btn" id="exportChatBtn" aria-label="Export chat" type="button">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="icon-btn" id="deleteChatBtn" aria-label="Delete chat" type="button">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>

                        <div class="messages-area" id="messagesArea" role="log" aria-live="polite">
                            <div class="messages-wrapper" id="messagesWrapper">
                                <!-- Messages will be populated here -->
                            </div>
                        </div>

                        <div class="input-area">
                            <div class="input-wrapper">
                                <div class="input-controls">
                                    <textarea 
                                        id="messageInput" 
                                        class="input-field" 
                                        placeholder="Scrivi un messaggio... (Ctrl+Enter per inviare)"
                                        rows="1"
                                        aria-label="Message input"
                                        autocomplete="off"
                                        spellcheck="true"
                                    ></textarea>
                                    <div class="input-actions">
                                        <button class="attach-btn" id="attachBtn" aria-label="Attach file" type="button" style="display: none;">
                                            <i class="fas fa-paperclip"></i>
                                        </button>
                                        <button class="send-btn" id="sendBtn" type="button">
                                            <span>Invia</span>
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Status Bar -->
        <div class="status-bar" id="statusBar" role="status">
            <div class="status-item">
                <div class="status-indicator" id="statusIndicator"></div>
                <span id="statusText">Inizializzazione...</span>
            </div>
            <div class="status-item">
                <i class="fas fa-message"></i>
                <span id="messageCount">0 messaggi</span>
            </div>
            <div class="status-item">
                <i class="fas fa-microchip"></i>
                <span id="modelStatus">Claude 3 Sonnet</span>
            </div>
            <div class="status-item" id="debugStatus" style="display: none;">
                <i class="fas fa-bug"></i>
                <span id="debugInfo">Debug</span>
            </div>
        </div>
    </div>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Debug Panel -->
    <div class="debug-panel" id="debugPanel" style="display: none;">
        <h3>Debug Information</h3>
        <div id="debugContent"></div>
        <button onclick="document.getElementById('debugPanel').style.display='none'">Close</button>
    </div>

    <!-- Puter.js Detection and Loading Script -->
    <script>
        // Puter.js loading with advanced retry logic
        window.PUTER_LOAD_ATTEMPTS = 0;
        window.MAX_PUTER_ATTEMPTS = 5;
        window.PUTER_LOAD_STATUS = 'pending';
        
        function loadPuterJS() {
            return new Promise((resolve, reject) => {
                window.PUTER_LOAD_ATTEMPTS++;
                console.log(`🔄 Tentativo caricamento Puter.js ${window.PUTER_LOAD_ATTEMPTS}/${window.MAX_PUTER_ATTEMPTS}`);
                
                // Update loading status
                const statusEl = document.getElementById('loadingStatus');
                if (statusEl) {
                    statusEl.textContent = `Caricamento Puter.js... (${window.PUTER_LOAD_ATTEMPTS}/${window.MAX_PUTER_ATTEMPTS})`;
                }
                
                const script = document.createElement('script');
                script.src = 'https://js.puter.com/v2/';
                script.async = true;
                script.crossOrigin = 'anonymous';
                
                script.onload = function() {
                    console.log('✅ Puter.js script caricato');
                    
                    // Verify Puter is available
                    setTimeout(() => {
                        if (typeof window.puter !== 'undefined') {
                            console.log('✅ Puter object disponibile:', window.puter);
                            window.PUTER_LOAD_STATUS = 'success';
                            
                            // Check for AI module
                            if (window.puter.ai) {
                                console.log('🤖 Puter.ai module disponibile');
                            } else {
                                console.warn('⚠️ Puter.ai module non trovato');
                            }
                            
                            resolve(true);
                        } else {
                            console.error('❌ Puter object non trovato dopo il caricamento');
                            window.PUTER_LOAD_STATUS = 'error';
                            reject(new Error('Puter object not found'));
                        }
                    }, 1000);
                };
                
                script.onerror = function(error) {
                    console.error('❌ Errore caricamento Puter.js:', error);
                    window.PUTER_LOAD_STATUS = 'error';
                    reject(error);
                };
                
                // Timeout fallback
                setTimeout(() => {
                    if (window.PUTER_LOAD_STATUS === 'pending') {
                        console.warn('⏱️ Timeout caricamento Puter.js');
                        window.PUTER_LOAD_STATUS = 'timeout';
                        reject(new Error('Puter.js load timeout'));
                    }
                }, 10000);
                
                document.head.appendChild(script);
            });
        }
        
        // Retry logic for Puter.js
        async function initializePuter() {
            while (window.PUTER_LOAD_ATTEMPTS < window.MAX_PUTER_ATTEMPTS) {
                try {
                    await loadPuterJS();
                    console.log('✅ Puter.js inizializzato con successo');
                    return true;
                } catch (error) {
                    console.error(`❌ Tentativo ${window.PUTER_LOAD_ATTEMPTS} fallito:`, error);
                    
                    if (window.PUTER_LOAD_ATTEMPTS < window.MAX_PUTER_ATTEMPTS) {
                        console.log(`⏳ Riprovo tra ${2 * window.PUTER_LOAD_ATTEMPTS} secondi...`);
                        await new Promise(resolve => setTimeout(resolve, 2000 * window.PUTER_LOAD_ATTEMPTS));
                    }
                }
            }
            
            console.error('❌ Impossibile caricare Puter.js dopo tutti i tentativi');
            return false;
        }
        
        // Create mock Puter for offline functionality
        window.createMockPuter = function() {
            console.warn('🔧 Creazione Mock Puter per modalità offline');
            
            window.puter = {
                ai: {
                    chat: async (message, options = {}) => {
                        console.log('🤖 Mock Puter.ai.chat chiamato:', { message, options });
                        
                        // Simulate API delay
                        const delay = 1000 + Math.random() * 2000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        
                        // Mock responses based on message
                        const responses = {
                            test: "✅ Test connessione riuscito! Modalità demo attiva.",
                            ciao: "Ciao! Sono in modalità demo. La connessione a Claude AI non è disponibile.",
                            default: `[Modalità Demo] Hai scritto: "${message}"\n\nPer utilizzare le vere capacità di Claude AI:\n1. Verifica la connessione internet\n2. Ricarica la pagina\n3. Controlla che Puter.js sia raggiungibile\n\nStato attuale: Offline/Demo Mode`
                        };
                        
                        const responseText = responses[message.toLowerCase()] || responses.default;
                        
                        // Simulate streaming if requested
                        if (options.stream) {
                            return {
                                [Symbol.asyncIterator]: async function* () {
                                    const words = responseText.split(' ');
                                    for (const word of words) {
                                        yield { text: word + ' ' };
                                        await new Promise(resolve => setTimeout(resolve, 50));
                                    }
                                }
                            };
                        }
                        
                        return { text: responseText };
                    }
                },
                fs: {
                    // Mock file system if needed
                    read: async () => null,
                    write: async () => true
                },
                auth: {
                    // Mock auth if needed
                    isSignedIn: async () => false,
                    signIn: async () => null
                }
            };
            
            window.PUTER_LOAD_STATUS = 'mock';
            return true;
        };
    </script>

    <!-- Load Puter.js -->
    <script src="https://js.puter.com/v2/" async crossorigin="anonymous"></script>
    
    <!-- Configuration -->
    <script src="assets/js/config.js"></script>
    
    <!-- Main Application -->
    <script src="assets/js/app.js"></script>
    
    <!-- Initialize App with Complete Error Handling -->
    <script>
        // Wait for DOM and all resources
        let domReady = false;
        let windowLoaded = false;
        let appInitialized = false;
        
        // DOM Ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                domReady = true;
                tryInitApp();
            });
        } else {
            domReady = true;
        }
        
        // Window Load
        window.addEventListener('load', () => {
            windowLoaded = true;
            tryInitApp();
        });
        
        // Initialize app when ready
        async function tryInitApp() {
            if (!domReady || appInitialized) return;
            
            appInitialized = true;
            console.log('🚀 Starting app initialization...');
            
            try {
                // Show progress
                const progressEl = document.getElementById('loadingProgress');
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                
                if (progressEl) {
                    progressEl.style.display = 'block';
                }
                
                // Step 1: Load Puter.js (50%)
                updateProgress(10, 'Caricamento Puter.js...');
                const puterLoaded = await initializePuter();
                
                if (!puterLoaded) {
                    console.warn('⚠️ Puter.js non disponibile, uso mock');
                    createMockPuter();
                }
                updateProgress(50, 'Puter.js caricato');
                
                // Step 2: Initialize App (80%)
                updateProgress(60, 'Inizializzazione app...');
                window.app = new ClaudeAIApp();
                updateProgress(80, 'App inizializzata');
                
                // Step 3: Final setup (100%)
                updateProgress(90, 'Configurazione finale...');
                
                // Setup debug mode
                if (window.DEBUG_MODE) {
                    document.getElementById('debugBtn').style.display = 'block';
                    document.getElementById('debugStatus').style.display = 'flex';
                }
                
                updateProgress(100, 'Pronto!');
                
                // Small delay for visual feedback
                setTimeout(() => {
                    console.log('✅ App initialization complete');
                }, 500);
                
            } catch (error) {
                console.error('❌ App initialization failed:', error);
                forceShowApp();
                showInitError(error);
            }
        }
        
        // Update progress bar
        function updateProgress(percent, status) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const loadingStatus = document.getElementById('loadingStatus');
            
            if (progressFill) progressFill.style.width = percent + '%';
            if (progressText) progressText.textContent = percent + '%';
            if (loadingStatus) loadingStatus.textContent = status;
        }
        
        // Force show app on error
        function forceShowApp() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
        }
        
        // Show initialization error
        function showInitError(error) {
            const welcomeStatus = document.getElementById('welcomeStatus');
            if (welcomeStatus) {
                welcomeStatus.innerHTML = `
                    <div class="error-message" style="
                        background: rgba(239, 68, 68, 0.1);
                        border: 1px solid rgba(239, 68, 68, 0.3);
                        color: #ef4444;
                        padding: 1rem;
                        border-radius: 0.5rem;
                        margin-top: 1rem;
                    ">
                        <i class="fas fa-exclamation-circle"></i>
                        <strong>Errore inizializzazione:</strong> ${error.message}<br>
                        <small>Modalità offline attiva. Alcune funzionalità potrebbero non essere disponibili.</small>
                    </div>
                `;
            }
        }
        
        // Emergency timeout - force show app after 10 seconds
        setTimeout(() => {
            if (document.getElementById('loadingScreen').style.display !== 'none') {
                console.warn('⏱️ Emergency timeout reached, forcing app display');
                forceShowApp();
                
                if (!window.app) {
                    try {
                        createMockPuter();
                        window.app = new ClaudeAIApp();
                    } catch (e) {
                        console.error('❌ Emergency init failed:', e);
                    }
                }
            }
        }, 10000);
        
        // Service Worker registration (non-blocking)
        if ('serviceWorker' in navigator && !window.DEBUG_MODE) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('📦 Service Worker registered:', reg))
                    .catch(err => console.warn('📦 Service Worker registration failed:', err));
            });
        }
        
        // Test connection button
        document.addEventListener('click', async (e) => {
            if (e.target.id === 'testConnectionBtn') {
                e.target.disabled = true;
                e.target.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
                
                try {
                    if (window.app) {
                        const result = await window.app.testConnection();
                        e.target.innerHTML = result.success ? 
                            '<i class="fas fa-check"></i> Connesso!' : 
                            '<i class="fas fa-times"></i> Offline';
                    }
                } catch (error) {
                    e.target.innerHTML = '<i class="fas fa-times"></i> Errore';
                }
                
                setTimeout(() => {
                    e.target.disabled = false;
                    e.target.innerHTML = '<i class="fas fa-network-wired"></i> Test Connessione';
                }, 3000);
            }
        });
    </script>
</body>
</html>
